<html>
	<head>
		<title>Swisssh</title>
		<script src="https://aframe.io/releases/0.8.0/aframe.min.js"></script>
		<style>
		html,body{
			background:#000;
			color:#fff;
			font-family: monospace;
		}
		#info{
			position: fixed;
			top:0;
			left:0;
			z-index: 2;
			padding:1rem;
		}
		#gameover{
			position: fixed;
			top:0;
			left:0;
			width:100vw;
			height:100vh;
			z-index:3;
			background-color:rgba(0,0,0,0.5);
			display: none;
		}
		#gameover h1{
			position: absolute;
			top:50%;
			left:50%;
			transform: translate(-50%,-50%);
		}
		</style>
	</head>
	<body onkeydown="handleKeypress(event)">
		<a-scene id="scene">
			<a-camera id="camera" wasd-controls-enabled="false"></a-camera>
			<a-entity id="tunnel-base">
				<a-plane position="5 0 -25" rotation="0 -90 90" width="10" height="50" color="#002"></a-plane>
				<a-plane position="0 -5 -25" rotation="-90 0 0" width="10" height="50" color="#020"></a-plane>
				<a-plane position="0 5 -25" rotation="90 0 0" width="10" height="50" color="#200"></a-plane>
				<a-plane position="-5 0 -25" rotation="0 90 90" width="10" height="50" color="#220"></a-plane>
			</a-entity>

			<a-sky color="#105"></a-sky>
		</a-scene>
		<div id="info">
			<h3 id="speed"></h3>
		</div>
		<div id="gameover">
			<h1>! GAME OVER !</h1>
		</div>
		<script type="text/javascript">
		var tunnelPiece=document.getElementById("tunnel-base"), camera=document.getElementById("camera"),scene=document.getElementById("scene"), speedCont=document.getElementById("speed");
		var position=0, speed=.1, campos={x:0,y:0,z:0}, waitFor=300, resetWaitFor=300;
		var tunnels=[tunnelPiece], obstacles=[];
		var colors=["#1abc9c","#2ecc71","#3498db","#9b59b6","#34495e","#f1c40f","#e67e22","#e74c3c","#ecf0f1","#95a5a6"];
		function stop(){
			clearInterval(fwd);
		}
		var fwd=setInterval(function(){
			camera.setAttribute("position",campos.x+" "+campos.y+" "+campos.z);
			campos.z-=speed;
			speedCont.innerHTML=speed.toFixed(3);
			if(--waitFor<=0){
				waitFor=resetWaitFor;
				resetWaitFor=Math.random()*200+200;
				addRandomObstacle();
			}
			//check collisions
			for(var k=0;k<obstacles.length;++k){
				var pos=obstacles[k].getAttribute("position");
				if(Math.abs(pos.x-campos.x)<=2.5 && Math.abs(pos.y-campos.y)<=2.5 && Math.abs(pos.z-campos.z)<=2.5){
					gameover();
				}
			}

			// check for next tunnel piece
			if(Math.abs(campos.z-position)<=100){
				addPiece();
				speed*=1.005;
			}
		},5);
		function addPiece(){
			position-=50;
			var newPiece=tunnelPiece.cloneNode(1);
			newPiece.setAttribute("position","0 0 "+position);
			scene.append(newPiece);
			tunnels.push(newPiece);
			if(tunnels.length>4){
				scene.removeChild(tunnels[0]);
				tunnels.splice(0,1); // rimuovo il primo elemento
			}
		}
		function addRandomObstacle(){
			var side = parseInt(Math.random()*4);
			var dist = -parseInt(80-campos.z);
			var pos = "";
			switch(side){
				case 0: pos="-2.5 -2.5 "+dist; break;
				case 1: pos="2.5 -2.5 "+dist; break;
				case 2: pos="-2.5 2.5 "+dist; break;
				case 3: pos="2.5 2.5 "+dist; break;
			}
			var obs=document.createElement("a-box");
			obs.setAttribute("position",pos);
			obs.setAttribute("scale","5 5 5");
			obs.setAttribute("color",colors[parseInt(Math.random()*10)]);
			scene.append(obs);
			obstacles.push(obs);

			if(obstacles.length>10){
				scene.removeChild(obstacles[0]);
				obstacles.splice(0,1);
			}
		}
		function gameover(){
			console.log("gameover");
			stop();
			document.getElementById("gameover").style.display="block";
		}
		function handleKeypress(e){
			var key=e.key;
		    switch(key){
		        case "ArrowRight":
					campos.x=2.5;
					break;
		        case "ArrowDown":
		            campos.y=-2.5;
		            break;
		        case "ArrowLeft":
					campos.x=-2.5;
					break;
		        case "ArrowUp":
					campos.y=2.5;
		            break;
		    }
		}
		</script>
	</body>
</html>
